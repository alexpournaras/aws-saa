# ⚖️ AWS Elastic Load Balancing (ELB) & Auto Scaling

## 🧩 Scalability Overview

### 📈 Vertical Scalability (Scale Up / Down)
- Increase the **size** of an instance (e.g., `t2.micro → t2.large`)
- Typically used for **databases**
- **hardware limit**

### 🌐 Horizontal Scalability (Scale Out / In): AWS Elasticity
- Increase the **number of instances**
- Requires **distributed application architecture**

### 🧭 High Availability
- Closely tied to **horizontal scaling**
- Deploy instances in **at least two Availability Zones (AZs)**
- Ensures system survives an **AZ failures**

---

## ⚙️ Load Balancers

A **Load Balancer** is a service that **forwards incoming traffic** across multiple servers to enhance **availability** and **performance**.

---

## 🧠 Application Load Balancer (ALB)

### 📡 Layer 7 (HTTP/HTTPS/WebSocket)
- Supports **HTTP**, **HTTPS**, and **WebSocket** protocols
- Can route based on:
  - **Path:** `example.com/users`
  - **Hostname:** `test.example.com`
  - **Query String:** `example.com/users?id=123`

### 🧱 Target Groups
- EC2 Instances  
- ECS Tasks  
- Lambda Functions  
- Private IP Addresses  

### ⚡ Features
- Ideal for **microservices** and **container-based applications**
- Can route to **multiple target groups**
- **Health checks** are configured at the target group level
- Provides a **fixed DNS name**:  
  `xxxx.region.elb.amazonaws.com`
- Client IP accessible via headers:
  - `X-Forwarded-For`
  - `X-Forwarded-Port`
  - `X-Forwarded-Proto`

---

## 🌐 Network Load Balancer (NLB)

### ⚡ Layer 4 (Transport Layer)
- Handles **TCP**, **UDP**, and **TLS (secure TCP)**
- Supports **millions of requests per second**
- **Ultra-low latency**
- Provides **one static IP per AZ** (can use **Elastic IP**)

### 🧱 Target Groups
- EC2 Instances  
- Private IP Addresses  
- Application Load Balancers  

### 🔍 Health Checks
- Supports **TCP**, **HTTP**, and **HTTPS**

---

## 🔒 Gateway Load Balancer (GWLB)

### 🧩 Layer 3 (Network Layer)
- Designed for **security and inspection appliances**
- Use cases:
  - Firewalls
  - Intrusion Detection / Prevention Systems (IDS/IPS)
  - Deep Packet Inspection (DPI)
  - Payload analysis & manipulation
- Uses **GENEVE protocol (port 6081)**
- For traffic that needs to go first to some 3rd party security virtual applicances (perhaps to inspect packets)

### 🧱 Target Groups
- EC2 Instances  
- Private IP Addresses  

---

## 🛡️ Security Group Configuration

| Component | Inbound Rules | Notes |
|------------|----------------|-------|
| **Load Balancer** | HTTP (80) / HTTPS (443) from `0.0.0.0/0` | Public access |
| **EC2 Instances** | HTTP (80) from Load Balancer’s security group | Restricted internal access |

---

## 🍪 Sticky Sessions (Session Affinity)

### 🎯 Purpose
Ensures that the **same client** is always routed to the **same instance** behind the load balancer.

- Implemented via **cookies**
- Prevents session loss for stateful applications
- May cause **uneven load distribution**

### 🍪 Types of Sticky Sessions

#### Application-Based Cookies
- **Custom Cookie:** Generated by target (not AWSALB, AWSALBAPP, AWSALBTG)
- **Application Cookie:** Generated by the ALB (`AWSALBAPP`)

#### Duration-Based Cookies
- Generated by the **Load Balancer** (`AWSALB`)
- Maintains session for a defined **time period**

---

## ⚖️ Cross-Zone Load Balancing

### ✅ Enabled
- Each instance across all AZs receives an **equal share** of traffic.

### 🚫 Disabled
- Traffic distributed **per AZ**, not per instance.

| Load Balancer | Default State | Billing Notes |
|----------------|----------------|----------------|
| **ALB** | Enabled by default, can be disabled from the target group | No extra charges |
| **NLB & GWLB** | Disabled by default | Extra cost if enabled |

---

SSL/TLS certificates

allow for traffic to be encrypted in transit (in flight)

SSL Secure sockets layer
TLS Transport layer security (its the newer version, mainly used but people keep saying them SSL)

public SSL Certificates are issued by Certificate Authorities (CA) (GoDaddy, Letsencrypt, etc.)

load balancer uses a X.509 certificate
we can manage certificates from ACM (AWS CERTIFICATE MANAGER)
 we can create and upload our own certificates
 clients in https listener can use sni server name indication to specify the hostname they reach

multiple ssl certificates
sni solves this problems

basically api.movies.com and movies.com can have different certificate???

--

connection draining / deregistration delay

basically the elb tries to forward a request to an instance but the instance is in unhealthy (draining) so the elb wait for that so it stop sending new requests to the instance which is deregistering

its like giving some times to already connected clients before the instance be shutdown because its marked as unhealth????

we can set that delay:

we can set from 0 (disabled) to 3600 seconds (default 300 seconds 5 minutes)

--

Auto scaling group (asg)
scale out ec2 instances to match increased load
scale in to decreased load
automatically register new instances to load balancer
recreate instance if old is unhealthy
its free!!!

launch template: AMI, instance type, ec2 user data, ebs volumes, security groups, ssh key pair, iam roles , network , load balancer information
min size, max size, initial capacity (desired)
scaling policies

possible to scale ASG based on CloudWatch alarms
(a metric like Average CPU)

scaling policies
* dynamic scaling (based on alarms/metrics (target tracking, simple, step scaling))
* scheduled scaling (increase capacity on saturday)
* predictive scaling (asg will analyse data and forecast what u need)

scaling cooldown
default 300 seconds 

during the cooldown asg will not launch or ternimate instances to allow for metrics to stabilize

advice: use ready-to-use amis to reduce configuration time in order to serve request faster and reduce cooldown period

